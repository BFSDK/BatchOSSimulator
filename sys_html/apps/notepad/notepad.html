<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #222;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .notepad-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #222;
        }

        .menu-bar {
            background: #333;
            border-bottom: 1px solid #444;
            padding: 2px 0;
            display: flex;
            font-size: 13px;
        }

        .menu-item {
            padding: 4px 12px;
            cursor: pointer;
            position: relative;
            color: #fff;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background: #444;
        }

        .menu-item.active {
            background: #555;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #333;
            border: 1px solid #555;
            min-width: 150px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }

        .dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            color: #fff;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background: #0078d4;
            color: white;
        }

        .dropdown-divider {
            height: 1px;
            background: #555;
            margin: 2px 0;
        }

        .text-area-container {
            flex: 1;
            position: relative;
            background: #222;
        }

        #textArea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.4;
            background: #1a1a1a;
            color: #fff;
            outline: none;
        }

        #textArea::placeholder {
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #333;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            width: 400px;
            max-width: 90%;
            border: 1px solid #555;
        }

        .modal-header {
            background: #222;
            color: #fff;
            padding: 12px 16px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-weight: bold;
            border-bottom: 1px solid #555;
        }

        .modal-body {
            padding: 16px;
            background: #333;
        }

        .modal-footer {
            padding: 12px 16px;
            background: #222;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-top: 1px solid #555;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #fff;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: #fff;
        }

        .form-control:focus {
            border-color: #0078d4;
            outline: none;
        }

        .btn {
            padding: 6px 16px;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #333;
            color: #fff;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .btn:hover {
            background: #444;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .file-list {
            border: 1px solid #555;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            background: #1a1a1a;
        }

        .file-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .file-item:hover {
            background: #333;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-weight: 500;
            color: #fff;
        }

        .file-date {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #333;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .custom-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            z-index: 3000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 300px;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="notepad-container">
        <div class="menu-bar">
            <div class="menu-item" onclick="toggleDropdown('fileDropdown')">
                File
                <div class="dropdown" id="fileDropdown">
                    <div class="dropdown-item" onclick="newFile()">New</div>
                    <div class="dropdown-item" onclick="openFile()">Open...</div>
                    <div class="dropdown-item" onclick="saveFile()">Save</div>
                    <div class="dropdown-item" onclick="saveAsFile()">Save As...</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="closeApp()">Exit</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="toggleDropdown('formatDropdown')">
                Format
                <div class="dropdown" id="formatDropdown">
                    <div class="dropdown-item" onclick="toggleWordWrap()">Word Wrap</div>
                    <div class="dropdown-item" onclick="changeFontSize()">Font Size</div>
                </div>
            </div>
        </div>

        <div class="text-area-container">
            <textarea id="textArea" placeholder="Start typing..."></textarea>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-header">Save File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fileName">File Name:</label>
                    <input type="text" id="fileName" class="form-control" placeholder="Enter file name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeSaveModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSave()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="openModal">
        <div class="modal-content">
            <div class="modal-header">Open File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select a file:</label>
                    <div class="file-list" id="fileList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeOpenModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmOpen()" disabled id="openBtn">Open</button>
            </div>
        </div>
    </div>

    <!-- Кастомный диалог для сообщений -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header" id="messageTitle">Message</div>
            <div class="modal-body">
                <p id="messageText"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeMessageModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let currentFileName = null;
        let wordWrapEnabled = true;
        let selectedFile = null;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Notepad initialized');
            loadSettings();
            updateTextAreaStyle();
            document.getElementById('textArea').focus();
        });

        // Универсальная функция показа сообщений (только для ошибок)
        function showDialog(message, title = 'Message') {
            console.log('Show dialog:', message);
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageModal').style.display = 'flex';
        }

        function closeMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        function closeApp() {
            if (isContentChanged()) {
                showDialog('You have unsaved changes. Please save before exiting.', 'Unsaved Changes');
                return;
            }
            
            window.parent.postMessage({
                type: 'BATCHOS_API',
                action: 'CLOSE_WINDOW',
                data: { windowId: getWindowId() }
            }, '*');
        }

        function getWindowId() {
            const iframe = window.frameElement;
            return iframe ? iframe.closest('.window')?.id : null;
        }

        // Функции меню
        function toggleDropdown(dropdownId) {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const dropdown = document.getElementById(dropdownId);
            const menuItem = dropdown.parentElement;
            
            dropdown.style.display = 'block';
            menuItem.classList.add('active');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-item')) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
            }
        });

        // Функции файлов
        function newFile() {
            if (isContentChanged()) {
                showDialog('You have unsaved changes. Please save your work before creating a new file.', 'Unsaved Changes');
                return;
            }
            
            document.getElementById('textArea').value = '';
            currentFileName = null;
            updateTitle();
            // Убрано уведомление об успешном создании
        }

        function openFile() {
            loadFileList();
            document.getElementById('openModal').style.display = 'flex';
            selectedFile = null;
            document.getElementById('openBtn').disabled = true;
        }

        function saveFile() {
            if (currentFileName) {
                performSave(currentFileName);
            } else {
                saveAsFile();
            }
        }

        function saveAsFile() {
            document.getElementById('saveModal').style.display = 'flex';
            document.getElementById('fileName').value = currentFileName || '';
            document.getElementById('fileName').focus();
        }

        // Функции формата
        function toggleWordWrap() {
            wordWrapEnabled = !wordWrapEnabled;
            updateTextAreaStyle();
            saveSettings();
            // Убрано уведомление о переключении Word Wrap
        }

        function changeFontSize() {
            const newSize = showPrompt('Enter font size (px):', '14');
            if (newSize && !isNaN(newSize)) {
                document.getElementById('textArea').style.fontSize = newSize + 'px';
                saveSettings();
                // Убрано уведомление об изменении размера шрифта
            }
        }

        // Модальные окна
        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        function closeOpenModal() {
            document.getElementById('openModal').style.display = 'none';
        }

        function confirmSave() {
            const fileName = document.getElementById('fileName').value.trim();
            if (!fileName) {
                showDialog('Please enter a file name');
                return;
            }
            
            performSave(fileName);
            closeSaveModal();
        }

        function confirmOpen() {
            if (selectedFile) {
                if (isContentChanged()) {
                    showDialog('You have unsaved changes. Please save your work before opening another file.', 'Unsaved Changes');
                    return;
                }
                
                const fileData = getFileFromStorage(selectedFile);
                if (fileData) {
                    document.getElementById('textArea').value = fileData.content;
                    currentFileName = selectedFile;
                    updateTitle();
                    closeOpenModal();
                    // Убрано уведомление об успешном открытии
                } else {
                    showDialog('Error: File not found');
                }
            }
        }

        // Работа с Local Storage
        function performSave(fileName) {
            try {
                const content = document.getElementById('textArea').value;
                console.log('Saving file:', fileName, 'Content length:', content.length);
                
                const fileData = {
                    content: content,
                    lastModified: new Date().toISOString(),
                    size: content.length
                };
                
                const files = JSON.parse(localStorage.getItem('notepad_files') || '{}');
                files[fileName] = fileData;
                localStorage.setItem('notepad_files', JSON.stringify(files));
                
                console.log('File saved to localStorage. Current files:', Object.keys(files));
                
                currentFileName = fileName;
                updateTitle();
                
                // Убрано уведомление об успешном сохранении
                
            } catch (e) {
                console.error('Save error:', e);
                showDialog('Error saving file: ' + e.message);
            }
        }

        function loadFileList() {
            try {
                const files = JSON.parse(localStorage.getItem('notepad_files') || '{}');
                const fileList = document.getElementById('fileList');
                
                console.log('Loading file list. Found files:', Object.keys(files));
                
                if (Object.keys(files).length === 0) {
                    fileList.innerHTML = '<div class="empty-state">No saved files found</div>';
                    return;
                }
                
                fileList.innerHTML = '';
                Object.keys(files).sort().forEach(fileName => {
                    const fileData = files[fileName];
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.onclick = () => selectFile(fileName);
                    
                    fileItem.innerHTML = `
                        <div class="file-name">${fileName}</div>
                        <div class="file-date">${new Date(fileData.lastModified).toLocaleString()} • ${fileData.size} chars</div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
            } catch (e) {
                console.error('Load file list error:', e);
                showDialog('Error loading file list: ' + e.message);
            }
        }

        function selectFile(fileName) {
            selectedFile = fileName;
            document.querySelectorAll('.file-item').forEach(item => {
                item.style.background = 'transparent';
            });
            event.target.closest('.file-item').style.background = '#444';
            document.getElementById('openBtn').disabled = false;
        }

        function getFileFromStorage(fileName) {
            try {
                const files = JSON.parse(localStorage.getItem('notepad_files') || '{}');
                console.log('Getting file:', fileName, 'Available files:', Object.keys(files));
                return files[fileName];
            } catch (e) {
                console.error('Get file error:', e);
                showDialog('Error reading file: ' + e.message);
                return null;
            }
        }

        // Вспомогательные функции
        function isContentChanged() {
            if (!currentFileName) {
                return document.getElementById('textArea').value.length > 0;
            }
            
            const savedFile = getFileFromStorage(currentFileName);
            if (!savedFile) return true;
            
            return savedFile.content !== document.getElementById('textArea').value;
        }

        function updateTitle() {
            const title = currentFileName ? `${currentFileName} - Notepad` : 'Untitled - Notepad';
            document.title = title;
        }

        function updateTextAreaStyle() {
            const textArea = document.getElementById('textArea');
            textArea.style.whiteSpace = wordWrapEnabled ? 'normal' : 'nowrap';
            textArea.style.overflowX = wordWrapEnabled ? 'hidden' : 'auto';
        }

        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('notepad_settings') || '{}');
                wordWrapEnabled = settings.wordWrap !== undefined ? settings.wordWrap : true;
                
                if (settings.fontSize) {
                    document.getElementById('textArea').style.fontSize = settings.fontSize + 'px';
                }
            } catch (e) {
                console.error('Load settings error:', e);
            }
        }

        function saveSettings() {
            try {
                const settings = {
                    wordWrap: wordWrapEnabled,
                    fontSize: parseInt(getComputedStyle(document.getElementById('textArea')).fontSize) || 14
                };
                localStorage.setItem('notepad_settings', JSON.stringify(settings));
            } catch (e) {
                console.error('Save settings error:', e);
            }
        }

        // Кастомный prompt
        function showPrompt(message, defaultValue = '') {
            return prompt(message, defaultValue);
        }

        // Обработчики клавиш
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                if (document.getElementById('saveModal').style.display === 'flex') {
                    closeSaveModal();
                }
                if (document.getElementById('openModal').style.display === 'flex') {
                    closeOpenModal();
                }
                if (document.getElementById('messageModal').style.display === 'flex') {
                    closeMessageModal();
                }
            }
            
            if (e.ctrlKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFile();
                        break;
                    case 'n':
                        e.preventDefault();
                        newFile();
                        break;
                }
            }
        });
    </script>
</body>
</html>