<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        body {
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #1e1e1e;
        }

        /* –ú–µ–Ω—é */
        .menu-bar {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            padding: 2px 0;
            display: flex;
            font-size: 13px;
            z-index: 1000;
        }

        .menu-item {
            padding: 4px 12px;
            cursor: pointer;
            position: relative;
            color: #cccccc;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .menu-item.active {
            background: #0078d4;
            color: white;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            min-width: 180px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            display: none;
            z-index: 1001;
        }

        .dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            color: #cccccc;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item:hover {
            background: #0078d4;
            color: white;
        }

        .dropdown-divider {
            height: 1px;
            background: #3e3e42;
            margin: 2px 0;
        }

        /* –ü–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ */
        .tabs-bar {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0 10px;
            height: 35px;
            overflow-x: auto;
        }

        .tab {
            padding: 6px 12px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            max-width: 200px;
            position: relative;
            color: #cccccc;
        }

        .tab.active {
            background: #1e1e1e;
            border-color: #0078d4;
            color: #ffffff;
        }

        .tab:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .tab-close {
            margin-left: auto;
            padding: 2px;
            border-radius: 2px;
            font-size: 10px;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-close:hover {
            background: #ff4444;
            color: white;
        }

        .tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tab-modified {
            color: #ffaa00;
            font-weight: bold;
            margin-left: 4px;
        }

        .add-tab {
            padding: 6px 10px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 14px;
            color: #cccccc;
        }

        .add-tab:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .toolbar {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 8px;
            border-right: 1px solid #3e3e42;
        }

        .tool-group:last-child {
            border-right: none;
        }

        button {
            background: #2d2d30;
            color: #cccccc;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #3e3e42;
            color: #ffffff;
            border-color: #0078d4;
        }

        button:focus {
            outline: none;
            border-color: #0078d4;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
        .main-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* –†–µ–¥–∞–∫—Ç–æ—Ä */
        .editor-wrapper {
            flex: 1;
            position: relative;
            background: #1e1e1e;
            overflow: hidden;
        }

        .editor-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            overflow: hidden;
        }

        .line-numbers {
            background: #1e1e1e;
            color: #6e7681;
            padding: 10px 8px;
            text-align: right;
            font-size: 14px;
            line-height: 1.5;
            border-right: 1px solid #3e3e42;
            user-select: none;
            overflow-y: auto;
            min-width: 60px;
        }

        .code-editor {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 10px;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            overflow-y: auto;
            white-space: pre;
            tab-size: 4;
        }

        .code-editor::selection {
            background: #264f78;
        }

        /* –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ */
        .debug-panel {
            width: 400px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .debug-panel.collapsed {
            width: 40px;
        }

        .debug-header {
            background: #2d2d30;
            padding: 8px 12px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #cccccc;
        }

        .debug-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .debug-tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }

        .debug-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #3e3e42;
            font-size: 12px;
            transition: background-color 0.2s;
            color: #cccccc;
        }

        .debug-tab.active {
            background: #0078d4;
            color: white;
        }

        .debug-tab:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .debug-output {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            background: #1e1e1e;
            color: #cccccc;
        }

        .preview-frame {
            flex: 1;
            border: none;
            background: white;
        }

        .toggle-debug {
            background: none;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .toggle-debug:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä */
        .status-bar {
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2d2d30;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            width: 500px;
            max-width: 90%;
            border: 1px solid #3e3e42;
        }

        .modal-header {
            background: #252526;
            color: #ffffff;
            padding: 12px 16px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-weight: bold;
            border-bottom: 1px solid #3e3e42;
        }

        .modal-body {
            padding: 16px;
            background: #2d2d30;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 12px 16px;
            background: #252526;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-top: 1px solid #3e3e42;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #ffffff;
        }

        .form-control {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-size: 14px;
            background: #1e1e1e;
            color: #ffffff;
        }

        .form-control:focus {
            border-color: #0078d4;
            outline: none;
        }

        .btn {
            padding: 6px 16px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #2d2d30;
            color: #cccccc;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .btn:hover {
            background: #3e3e42;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .file-list {
            border: 1px solid #3e3e42;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            background: #1e1e1e;
        }

        .file-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #2d2d30;
            font-size: 13px;
            transition: background-color 0.2s;
            color: #cccccc;
        }

        .file-item:hover {
            background: #2d2d30;
            color: #ffffff;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-weight: 500;
            color: #ffffff;
        }

        .file-date {
            font-size: 11px;
            color: #888888;
            margin-top: 2px;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #666666;
            font-style: italic;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Ç–ª–∞–¥–∫–µ */
        .log-message {
            padding: 4px 0;
            border-bottom: 1px solid #2d2d30;
        }

        .log-info { color: #cccccc; }
        .log-error { color: #ff4444; }
        .log-warning { color: #ffaa00; }
        .log-success { color: #44ff44; }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d30;
        }

        ::-webkit-scrollbar-thumb {
            background: #3e3e42;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0078d4;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é -->
        <div class="menu-bar">
            <div class="menu-item" onclick="codeEditor.toggleDropdown('fileDropdown')">
                File
                <div class="dropdown" id="fileDropdown">
                    <div class="dropdown-item" onclick="codeEditor.newFile()">
                        <span>üìÑ</span> New File
                    </div>
                    <div class="dropdown-item" onclick="codeEditor.openFile()">
                        <span>üìÇ</span> Open...
                    </div>
                    <div class="dropdown-item" onclick="codeEditor.saveFile()">
                        <span>üíæ</span> Save
                    </div>
                    <div class="dropdown-item" onclick="codeEditor.saveAsFile()">
                        <span>üíæ</span> Save As...
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="codeEditor.closeApp()">
                        <span>üö™</span> Exit
                    </div>
                </div>
            </div>
            
            <div class="menu-item" onclick="codeEditor.toggleDropdown('editDropdown')">
                Edit
                <div class="dropdown" id="editDropdown">
                    <div class="dropdown-item" onclick="codeEditor.undo()">
                        <span>‚Ü∂</span> Undo
                    </div>
                    <div class="dropdown-item" onclick="codeEditor.redo()">
                        <span>‚Ü∑</span> Redo
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="codeEditor.selectAll()">
                        <span>üî†</span> Select All
                    </div>
                    <div class="dropdown-item" onclick="codeEditor.findText()">
                        <span>üîç</span> Find
                    </div>
                </div>
            </div>
            
            <div class="menu-item" onclick="codeEditor.toggleDropdown('debugDropdown')">
                Debug
                <div class="dropdown" id="debugDropdown">
                    <div class="dropdown-item" onclick="codeEditor.runCode()">
                        <span>‚ñ∂Ô∏è</span> Run Code
                    </div>
                    <div class="dropdown-item" onclick="codeEditor.debugHTML()">
                        <span>üõ†Ô∏è</span> Debug HTML
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="codeEditor.clearConsole()">
                        <span>üßπ</span> Clear Console
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
        <div class="tabs-bar" id="tabsBar">
            <!-- –í–∫–ª–∞–¥–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="toolbar">
            <div class="tool-group">
                <button onclick="codeEditor.runCode()" title="Run Code (F5)">‚ñ∂ Run</button>
                <button onclick="codeEditor.debugHTML()" title="Debug HTML (F6)">üõ† Debug HTML</button>
            </div>
            
            <div class="tool-group">
                <button onclick="codeEditor.toggleDebugPanel()" id="toggleDebugBtn">üìã Console</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-area">
            <!-- –†–µ–¥–∞–∫—Ç–æ—Ä -->
            <div class="editor-wrapper">
                <div class="editor-area" id="editorArea">
                    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
            <div class="debug-panel" id="debugPanel">
                <div class="debug-header">
                    <span>Debug Console</span>
                    <button class="toggle-debug" onclick="codeEditor.toggleDebugPanel()">√ó</button>
                </div>
                <div class="debug-content">
                    <div class="debug-tabs">
                        <div class="debug-tab active" onclick="codeEditor.switchDebugTab('console')">Console</div>
                        <div class="debug-tab" onclick="codeEditor.switchDebugTab('preview')">Preview</div>
                        <div class="debug-tab" onclick="codeEditor.switchDebugTab('output')">Output</div>
                    </div>
                    
                    <div id="consoleTab" class="debug-output">
                        <div class="log-message log-info">Code Editor initialized. Ready to debug!</div>
                    </div>
                    
                    <div id="previewTab" class="debug-output" style="display: none;">
                        <iframe id="previewFrame" class="preview-frame"></iframe>
                    </div>
                    
                    <div id="outputTab" class="debug-output" style="display: none;">
                        <div class="log-message log-info">Program output will appear here...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <div class="status-bar">
            <div id="cursorPosition">Line: 1, Column: 1</div>
            <div id="fileInfo">Untitled.html</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-header">Save File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fileName">File Name:</label>
                    <input type="text" id="fileName" class="form-control" placeholder="Enter file name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="codeEditor.closeSaveModal()">Cancel</button>
                <button class="btn btn-primary" onclick="codeEditor.confirmSave()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="openModal">
        <div class="modal-content">
            <div class="modal-header">Open File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select a file:</label>
                    <div class="file-list" id="fileList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="codeEditor.closeOpenModal()">Cancel</button>
                <button class="btn btn-primary" onclick="codeEditor.confirmOpen()" disabled id="openBtn">Open</button>
            </div>
        </div>
    </div>

    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header" id="messageTitle">Message</div>
            <div class="modal-body">
                <p id="messageText"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="codeEditor.closeMessageModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // –û–±—ä–µ–∫—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∫–æ–¥–∞
        const codeEditor = {
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            tabs: [],
            activeTabId: null,
            editors: new Map(),
            codeFiles: {},
            selectedFile: null,
            history: new Map(), // –î–ª—è undo/redo

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            init: function() {
                console.log('Code Editor initialized');
                this.setupEventListeners();
                this.createNewTab();
                this.loadCodeFiles();
            },

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners: function() {
                // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.menu-item')) {
                        this.hideAllDropdowns();
                    }
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏
                const tabsBar = document.getElementById('tabsBar');
                const addTabBtn = document.createElement('div');
                addTabBtn.className = 'add-tab';
                addTabBtn.innerHTML = '+';
                addTabBtn.title = 'New Tab (Ctrl+T)';
                addTabBtn.onclick = () => this.createNewTab();
                tabsBar.appendChild(addTabBtn);
            },

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
            createNewTab: function(content = '', fileName = null) {
                const tabId = 'tab_' + Date.now();
                const tabName = fileName || `Untitled${this.tabs.length + 1}.txt`;
                
                const tab = {
                    id: tabId,
                    name: tabName,
                    fileName: fileName,
                    content: content || this.getDefaultContent(),
                    hasChanges: false,
                    history: [],
                    historyIndex: -1
                };
                
                this.tabs.push(tab);
                this.activeTabId = tabId;
                
                this.createTabElement(tab);
                this.createEditor(tab);
                this.updateTabDisplay();
                this.updateFileInfo();
                
                return tabId;
            },

            createTabElement: function(tab) {
                const tabsBar = document.getElementById('tabsBar');
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.id = `tab_el_${tab.id}`;
                tabElement.innerHTML = `
                    <span class="tab-name">${tab.name}</span>
                    <span class="tab-modified">${tab.hasChanges ? '‚Ä¢' : ''}</span>
                    <span class="tab-close" onclick="codeEditor.closeTab('${tab.id}', event)">√ó</span>
                `;
                tabElement.onclick = (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        this.switchTab(tab.id);
                    }
                };
                
                const addTabBtn = tabsBar.querySelector('.add-tab');
                tabsBar.insertBefore(tabElement, addTabBtn);
            },

            createEditor: function(tab) {
                const editorArea = document.getElementById('editorArea');
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –≤–∫–ª–∞–¥–∫–∞
                if (this.tabs.length === 1) {
                    editorArea.innerHTML = '';
                }
                
                const editorWrapper = document.createElement('div');
                editorWrapper.id = `editor_${tab.id}`;
                editorWrapper.className = 'editor-tab';
                editorWrapper.style.display = 'none';
                editorWrapper.style.width = '100%';
                editorWrapper.style.height = '100%';
                
                const lineNumbers = document.createElement('div');
                lineNumbers.className = 'line-numbers';
                lineNumbers.id = `lines_${tab.id}`;
                
                const textarea = document.createElement('textarea');
                textarea.className = 'code-editor';
                textarea.id = `textarea_${tab.id}`;
                textarea.value = tab.content;
                textarea.spellcheck = false;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
                textarea.addEventListener('input', (e) => {
                    this.onContentChange(tab.id, e.target.value);
                });
                
                textarea.addEventListener('scroll', (e) => {
                    this.syncScroll(tab.id);
                });
                
                textarea.addEventListener('keydown', (e) => {
                    this.handleKeydown(tab.id, e);
                });
                
                textarea.addEventListener('click', (e) => {
                    this.updateCursorPosition(tab.id);
                });
                
                textarea.addEventListener('keyup', (e) => {
                    this.updateCursorPosition(tab.id);
                });
                
                editorWrapper.appendChild(lineNumbers);
                editorWrapper.appendChild(textarea);
                editorArea.appendChild(editorWrapper);
                
                this.editors.set(tab.id, textarea);
                this.updateLineNumbers(tab.id);
                this.saveToHistory(tab.id, tab.content);
            },

            onContentChange: function(tabId, content) {
                const tab = this.getTabById(tabId);
                if (tab) {
                    tab.content = content;
                    tab.hasChanges = true;
                    this.updateTabDisplay();
                    this.updateFileInfo();
                    this.updateLineNumbers(tabId);
                    this.saveToHistory(tabId, content);
                }
            },

            updateLineNumbers: function(tabId) {
                const lineNumbers = document.getElementById(`lines_${tabId}`);
                const textarea = this.editors.get(tabId);
                
                if (!lineNumbers || !textarea) return;
                
                const lines = textarea.value.split('\n').length;
                let numbersHTML = '';
                
                for (let i = 1; i <= lines; i++) {
                    numbersHTML += i + '<br>';
                }
                
                lineNumbers.innerHTML = numbersHTML;
            },

            syncScroll: function(tabId) {
                const lineNumbers = document.getElementById(`lines_${tabId}`);
                const textarea = this.editors.get(tabId);
                
                if (lineNumbers && textarea) {
                    lineNumbers.scrollTop = textarea.scrollTop;
                }
            },

            handleKeydown: function(tabId, event) {
                const textarea = this.editors.get(tabId);
                
                // Tab support
                if (event.key === 'Tab') {
                    event.preventDefault();
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    
                    textarea.value = textarea.value.substring(0, start) + '    ' + textarea.value.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + 4;
                    
                    this.onContentChange(tabId, textarea.value);
                }
                
                // Ctrl+S for save
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();
                    this.saveFile();
                }
            },

            updateCursorPosition: function(tabId) {
                const textarea = this.editors.get(tabId);
                if (!textarea) return;
                
                const text = textarea.value.substring(0, textarea.selectionStart);
                const lines = text.split('\n');
                const line = lines.length;
                const column = lines[lines.length - 1].length + 1;
                
                document.getElementById('cursorPosition').textContent = `Line: ${line}, Column: ${column}`;
            },

            switchTab: function(tabId) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
                document.querySelectorAll('.editor-tab').forEach(editor => {
                    editor.style.display = 'none';
                });
                
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
                const editorElement = document.getElementById(`editor_${tabId}`);
                if (editorElement) {
                    editorElement.style.display = 'flex';
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                const tabElement = document.getElementById(`tab_el_${tabId}`);
                if (tabElement) {
                    tabElement.classList.add('active');
                }
                
                this.activeTabId = tabId;
                const tab = this.getTabById(tabId);
                if (tab) {
                    this.updateFileInfo();
                    const editor = this.editors.get(tabId);
                    if (editor) {
                        editor.focus();
                        this.updateCursorPosition(tabId);
                        this.updateLineNumbers(tabId);
                    }
                }
            },

            closeTab: function(tabId, event) {
                if (event) event.stopPropagation();
                
                const tab = this.getTabById(tabId);
                if (tab && tab.hasChanges) {
                    if (!confirm(`Save changes to ${tab.name}?`)) {
                        return;
                    }
                    this.saveTab(tab);
                }
                
                // –£–¥–∞–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É
                this.tabs = this.tabs.filter(t => t.id !== tabId);
                
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                const tabElement = document.getElementById(`tab_el_${tabId}`);
                if (tabElement) {
                    tabElement.remove();
                }
                
                const editorElement = document.getElementById(`editor_${tabId}`);
                if (editorElement) {
                    editorElement.remove();
                }
                
                this.editors.delete(tabId);
                
                // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥—É—é
                if (this.activeTabId === tabId) {
                    if (this.tabs.length > 0) {
                        this.switchTab(this.tabs[this.tabs.length - 1].id);
                    } else {
                        this.createNewTab();
                    }
                }
            },

            updateTabDisplay: function() {
                this.tabs.forEach(tab => {
                    const tabElement = document.getElementById(`tab_el_${tab.id}`);
                    if (tabElement) {
                        const modifiedElement = tabElement.querySelector('.tab-modified');
                        modifiedElement.textContent = tab.hasChanges ? '‚Ä¢' : '';
                    }
                });
            },

            getTabById: function(tabId) {
                return this.tabs.find(tab => tab.id === tabId);
            },

            getCurrentTab: function() {
                return this.getTabById(this.activeTabId);
            },

            getCurrentEditor: function() {
                return this.editors.get(this.activeTabId);
            },

            // –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø—Ä–æ—Å—Ç–æ–π undo/redo)
            saveToHistory: function(tabId, content) {
                const tab = this.getTabById(tabId);
                if (!tab) return;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (tab.history[tab.historyIndex] !== content) {
                    tab.history = tab.history.slice(0, tab.historyIndex + 1);
                    tab.history.push(content);
                    tab.historyIndex++;
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
                    if (tab.history.length > 50) {
                        tab.history.shift();
                        tab.historyIndex--;
                    }
                }
            },

            undo: function() {
                const tab = this.getCurrentTab();
                const editor = this.getCurrentEditor();
                
                if (tab && editor && tab.historyIndex > 0) {
                    tab.historyIndex--;
                    const content = tab.history[tab.historyIndex];
                    editor.value = content;
                    tab.content = content;
                    this.updateLineNumbers(tab.id);
                    this.updateCursorPosition(tab.id);
                }
            },

            redo: function() {
                const tab = this.getCurrentTab();
                const editor = this.getCurrentEditor();
                
                if (tab && editor && tab.historyIndex < tab.history.length - 1) {
                    tab.historyIndex++;
                    const content = tab.history[tab.historyIndex];
                    editor.value = content;
                    tab.content = content;
                    this.updateLineNumbers(tab.id);
                    this.updateCursorPosition(tab.id);
                }
            },

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            getDefaultContent: function() {
                return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Hello, World!</h1>
    <p>Welcome to Code Editor</p>
    
    <script>
        console.log('HTML page loaded successfully!');
    <\\/script>
</body>
</html>`;
            },

            // –§—É–Ω–∫—Ü–∏–∏ –º–µ–Ω—é
            toggleDropdown: function(dropdownId) {
                this.hideAllDropdowns();
                const dropdown = document.getElementById(dropdownId);
                const menuItem = dropdown.parentElement;
                dropdown.style.display = 'block';
                menuItem.classList.add('active');
            },

            hideAllDropdowns: function() {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
            },

            // –ö–æ–º–∞–Ω–¥—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            selectAll: function() {
                const editor = this.getCurrentEditor();
                if (editor) {
                    editor.select();
                }
            },

            findText: function() {
                const searchText = prompt('Enter text to find:');
                if (searchText) {
                    const editor = this.getCurrentEditor();
                    if (editor) {
                        const content = editor.value;
                        const index = content.indexOf(searchText);
                        if (index !== -1) {
                            editor.focus();
                            editor.setSelectionRange(index, index + searchText.length);
                        } else {
                            alert('Text not found');
                        }
                    }
                }
            },

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
            updateFileInfo: function() {
                const tab = this.getCurrentTab();
                if (tab) {
                    const fileName = tab.fileName || tab.name;
                    document.getElementById('fileInfo').textContent = fileName;
                }
            },

            // –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏
            toggleDebugPanel: function() {
                const panel = document.getElementById('debugPanel');
                const btn = document.getElementById('toggleDebugBtn');
                
                if (panel.classList.contains('collapsed')) {
                    panel.classList.remove('collapsed');
                    btn.textContent = 'üìã Console';
                } else {
                    panel.classList.add('collapsed');
                    btn.textContent = '‚ñ∂ Console';
                }
            },

            switchDebugTab: function(tabName) {
                document.querySelectorAll('.debug-output').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                document.querySelectorAll('.debug-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(tabName + 'Tab').style.display = 'block';
                event.target.classList.add('active');
            },

            addToConsole: function(message, type = 'info') {
                const consoleTab = document.getElementById('consoleTab');
                const logMessage = document.createElement('div');
                logMessage.className = `log-message log-${type}`;
                logMessage.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                consoleTab.appendChild(logMessage);
                consoleTab.scrollTop = consoleTab.scrollHeight;
            },

            clearConsole: function() {
                document.getElementById('consoleTab').innerHTML = '';
                this.addToConsole('Console cleared', 'info');
            },

            // –ó–∞–ø—É—Å–∫ –∫–æ–¥–∞
            runCode: function() {
                const tab = this.getCurrentTab();
                if (!tab) return;
                
                const code = tab.content;
                this.addToConsole('Running code...', 'info');
                
                try {
                    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ HTML
                    if (code.includes('<html') || code.includes('<!DOCTYPE')) {
                        this.debugHTML();
                    } else if (code.includes('function') || code.includes('console.log')) {
                        // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å JavaScript
                        try {
                            const output = eval(code);
                            this.addToConsole(`Code executed successfully. Output: ${output}`, 'success');
                        } catch (jsError) {
                            this.addToConsole(`JavaScript Error: ${jsError.message}`, 'error');
                        }
                    } else {
                        this.switchDebugTab('output');
                        const outputTab = document.getElementById('outputTab');
                        outputTab.innerHTML = `<div class="log-message log-info">Code output:</div>
                                              <div class="preview-content">${code}</div>`;
                        this.addToConsole('Code prepared for execution', 'info');
                    }
                } catch (error) {
                    this.addToConsole(`Error: ${error.message}`, 'error');
                }
            },

            // –û—Ç–ª–∞–¥–∫–∞ HTML
            debugHTML: function() {
                const tab = this.getCurrentTab();
                if (!tab) return;
                
                const htmlCode = tab.content;
                this.addToConsole('Debugging HTML...', 'info');
                
                // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è HTML
                if (!htmlCode.includes('<html') && !htmlCode.includes('<!DOCTYPE')) {
                    this.addToConsole('Warning: Missing HTML doctype or html tag', 'warning');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                this.switchDebugTab('preview');
                const previewFrame = document.getElementById('previewFrame');
                const blob = new Blob([htmlCode], { type: 'text/html' });
                previewFrame.src = URL.createObjectURL(blob);
                
                this.addToConsole('HTML debugging completed. Check Preview tab.', 'success');
            },

            // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
            loadCodeFiles: function() {
                try {
                    const files = JSON.parse(localStorage.getItem('code_files') || '{}');
                    this.codeFiles = files;
                    console.log('Loaded code files:', Object.keys(files));
                } catch (e) {
                    console.error('Error loading code files:', e);
                    this.codeFiles = {};
                }
            },

            newFile: function() {
                this.createNewTab();
                this.addToConsole('New file created', 'info');
            },

            openFile: function() {
                this.loadFileList();
                document.getElementById('openModal').style.display = 'flex';
                this.selectedFile = null;
                document.getElementById('openBtn').disabled = true;
            },

            saveFile: function() {
                const tab = this.getCurrentTab();
                if (tab && tab.fileName) {
                    this.saveTab(tab);
                } else {
                    this.saveAsFile();
                }
            },

            saveAsFile: function() {
                document.getElementById('saveModal').style.display = 'flex';
                const tab = this.getCurrentTab();
                document.getElementById('fileName').value = tab ? (tab.fileName || tab.name) : '';
                document.getElementById('fileName').focus();
            },

            saveTab: function(tab) {
                const fileName = tab.fileName || tab.name;
                this.performSave(fileName, tab);
            },

            closeSaveModal: function() {
                document.getElementById('saveModal').style.display = 'none';
            },

            closeOpenModal: function() {
                document.getElementById('openModal').style.display = 'none';
            },

            confirmSave: function() {
                const fileName = document.getElementById('fileName').value.trim();
                if (!fileName) {
                    this.showDialog('Please enter a file name');
                    return;
                }
                
                const tab = this.getCurrentTab();
                if (tab) {
                    this.performSave(fileName, tab);
                }
                this.closeSaveModal();
            },

            confirmOpen: function() {
                if (this.selectedFile) {
                    const fileData = this.getFileFromStorage(this.selectedFile);
                    if (fileData) {
                        this.createNewTab(fileData.content, this.selectedFile);
                        this.closeOpenModal();
                        this.addToConsole(`File "${this.selectedFile}" opened`, 'success');
                    } else {
                        this.showDialog('Error: File not found');
                    }
                }
            },

            performSave: function(fileName, tab) {
                try {
                    const fileData = {
                        content: tab.content,
                        lastModified: new Date().toISOString(),
                        size: tab.content.length
                    };
                    
                    this.codeFiles[fileName] = fileData;
                    localStorage.setItem('code_files', JSON.stringify(this.codeFiles));
                    
                    tab.fileName = fileName;
                    tab.name = fileName;
                    tab.hasChanges = false;
                    this.updateTabDisplay();
                    this.updateFileInfo();
                    this.addToConsole(`File "${fileName}" saved`, 'success');
                    
                } catch (e) {
                    console.error('Save error:', e);
                    this.showDialog('Error saving file: ' + e.message);
                }
            },

            loadFileList: function() {
                try {
                    const files = this.codeFiles;
                    const fileList = document.getElementById('fileList');
                    
                    if (Object.keys(files).length === 0) {
                        fileList.innerHTML = '<div class="empty-state">No saved code files found</div>';
                        return;
                    }
                    
                    fileList.innerHTML = '';
                    Object.keys(files).sort().forEach(fileName => {
                        const fileData = files[fileName];
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.onclick = () => this.selectFile(fileName);
                        
                        fileItem.innerHTML = `
                            <div class="file-name">${fileName}</div>
                            <div class="file-date">${new Date(fileData.lastModified).toLocaleString()} ‚Ä¢ ${fileData.size} chars</div>
                        `;
                        
                        fileList.appendChild(fileItem);
                    });
                } catch (e) {
                    console.error('Load file list error:', e);
                    this.showDialog('Error loading file list: ' + e.message);
                }
            },

            selectFile: function(fileName) {
                this.selectedFile = fileName;
                document.querySelectorAll('.file-item').forEach(item => {
                    item.style.background = 'transparent';
                });
                event.target.closest('.file-item').style.background = '#2d2d30';
                document.getElementById('openBtn').disabled = false;
            },

            getFileFromStorage: function(fileName) {
                return this.codeFiles[fileName];
            },

            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            showDialog: function(message, title = 'Message') {
                document.getElementById('messageTitle').textContent = title;
                document.getElementById('messageText').textContent = message;
                document.getElementById('messageModal').style.display = 'flex';
            },

            closeMessageModal: function() {
                document.getElementById('messageModal').style.display = 'none';
            },

            closeApp: function() {
                window.parent.postMessage({
                    type: 'BATCHOS_API',
                    action: 'CLOSE_WINDOW',
                    data: { windowId: this.getWindowId() }
                }, '*');
            },

            getWindowId: function() {
                const iframe = window.frameElement;
                return iframe ? iframe.closest('.window')?.id : null;
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            codeEditor.init();
        });

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5') {
                e.preventDefault();
                codeEditor.runCode();
            }
            
            if (e.key === 'F6') {
                e.preventDefault();
                codeEditor.debugHTML();
            }
            
            if (e.ctrlKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        codeEditor.saveFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        codeEditor.openFile();
                        break;
                    case 'n':
                        e.preventDefault();
                        codeEditor.newFile();
                        break;
                    case 'f':
                        e.preventDefault();
                        codeEditor.findText();
                        break;
                    case 't':
                        e.preventDefault();
                        codeEditor.createNewTab();
                        break;
                    case 'w':
                        e.preventDefault();
                        if (codeEditor.getCurrentTab()) {
                            codeEditor.closeTab(codeEditor.activeTabId, {stopPropagation: () => {}});
                        }
                        break;
                    case 'z':
                        e.preventDefault();
                        codeEditor.undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        codeEditor.redo();
                        break;
                    case 'a':
                        e.preventDefault();
                        codeEditor.selectAll();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                codeEditor.hideAllDropdowns();
                codeEditor.closeSaveModal();
                codeEditor.closeOpenModal();
                codeEditor.closeMessageModal();
            }
        });
    </script>
</body>
</html>